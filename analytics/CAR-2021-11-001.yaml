title: Registry edit with creation of SafeDllSearchMode key set to 0
submission_date: 2021/11/24
information_domain: Host
platforms:
  - Windows
subtypes:
  - Process
  - Registry
analytic_types:
  - TTP
contributors:
  - Lucas Heiligenstein
id: CAR-2021-11-001
description: |-
  Detection of creation of registry key HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Session Manager\SafeDllSearchMode. The key SafeDllSearchMode, if set to 0, will block the Windows mechanism for the search DLL order and adversaries may execute their own malicious dll.
coverage:
  - technique: T1574
    tactics:
      - TA0003
      - TA0004
      - TA0005
    subtechniques:
      - T1574.001
    coverage: Medium
  - technique: T1112
    tactics:
      - TA0005
    subtechniques:
      - T1112
    coverage: Medium
implementations:
  - name: Splunk Search - Creation of SafeDllSearchMode
    description: This is a pseudocode representation of the below Splunk search.
    code: |- 
      (source="WinEventLog:*" EventLog="Security" ((EventCode="4688" ((CommandLine="*reg*" CommandLine="*add*" CommandLine="*/d*") OR (CommandLine="*Set-ItemProperty*" CommandLine="*-value*")) ("0" OR "*00000000") CommandLine="*SafeDllSearchMode*") OR (EventCode="4657" ObjectValueName="SafeDllSearchMode" NewValue="0")))
    type: Splunk
  - name: Elastic Search - Creation of SafeDllSearchMode
    description: This is a pseudocode representation of the below Elastic search.
    code: |- 
      (EventLog:"Security" AND ((winlog.event_id:"4688" AND ((process.command_line:*reg* AND process.command_line:*add* AND process.command_line:*\/d*) OR (process.command_line:*Set\-ItemProperty* AND process.command_line:*\-value*)) AND (*0* OR *00000000*) AND process.command_line:*SafeDllSearchMode*) OR (winlog.event_id:"4657" AND winlog.event_data.ObjectValueName:"SafeDllSearchMode" AND NewValue:"0")))
    type: Elastic
  - name: LogPoint Search - Creation of SafeDllSearchMode
    description: This is a pseudocode representation of the below LogPoint search.
    code: |- 
      (EventLog="Security" ((event_id="4688" ((CommandLine="*reg*" CommandLine="*add*" CommandLine="*/d*") OR (CommandLine="*Set-ItemProperty*" CommandLine="*-value*")) ("0" OR "*00000000") CommandLine="*SafeDllSearchMode*") OR (event_id="4657" ObjectValueName="SafeDllSearchMode" NewValue="0")))
    type: LogPoint
unit_tests:
- configurations:
  description: Execute command with cmd
  commands:
  - reg add "HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Session Manager" /v SafeDllSearchMode /d 0
- configurations:
  description: Execute command with powershell
  commands:
  - Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Session Manager" -Name SafeDllSearchMode -Value 0
data_model_references:
  - process/create/command_line
  - registry/add/key
